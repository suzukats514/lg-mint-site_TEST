<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MLG Mint Access</title>

<style>
  :root {
    color-scheme: dark;
    --bg-deep:#030816;
    --card-bg:rgba(15,20,35,0.75);
    --card-border:#00baff;
    --accent:#00cfff;
    --accent-glow:rgba(0,191,255,0.35);
    --text-main:#f8fafc;
    --text-dim:#94a3b8;
    --text-warn:#facc15;
    --text-err:#f87171;
    --text-ok:#4ade80;
    --radius-lg:16px;
    --radius-sm:8px;
    --font-main:"Exo 2", "Rajdhani", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  @keyframes glowPulse {
    0%   { box-shadow:0 0 12px var(--accent-glow),0 0 48px var(--accent-glow); }
    50%  { box-shadow:0 0 24px var(--accent-glow),0 0 64px var(--accent-glow); }
    100% { box-shadow:0 0 12px var(--accent-glow),0 0 48px var(--accent-glow); }
  }

  * {
    box-sizing:border-box;
  }

  body {
    margin:0;
    min-height:100vh;
    background:radial-gradient(circle at 30% 20%, rgba(32,58,97,.5) 0%, rgba(0,0,0,0) 60%),
               radial-gradient(circle at 70% 60%, rgba(0,14,50,.6) 0%, rgba(0,0,0,0) 60%),
               var(--bg-deep) url('https://images.unsplash.com/photo-1447433909565-04bfc496fe3d?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat fixed;
    font-family:var(--font-main);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    color:var(--text-main);
  }

  .card {
    width:100%;
    max-width:400px;
    background:var(--card-bg);
    border:1px solid var(--card-border);
    border-radius:var(--radius-lg);
    box-shadow:0 30px 80px rgba(0,0,0,.8),0 0 60px rgba(0,191,255,.2);
    padding:24px 24px 20px;
    backdrop-filter: blur(10px);
    position:relative;
  }

  .meteor-icon {
    width:64px;
    height:64px;
    border-radius:999px;
    border:2px solid var(--accent);
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 auto 12px;
    color:var(--accent);
    font-size:26px;
    line-height:1;
    font-weight:600;
    animation:glowPulse 3s infinite;
    text-shadow:0 0 10px var(--accent),0 0 30px var(--accent);
  }

  .title-main {
    text-align:center;
    font-size:20px;
    font-weight:600;
    color:var(--text-main);
    letter-spacing:.03em;
  }
  .subtitle {
    text-align:center;
    font-size:14px;
    font-weight:400;
    color:var(--text-dim);
    margin-top:8px;
    line-height:1.4;
  }

  .statusRow {
    margin-top:20px;
    font-size:12px;
    color:var(--text-dim);
    line-height:1.4;
    text-align:center;
  }
  .addrTag,
  .netTag {
    display:inline-block;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(148,163,184,.3);
    border-radius:var(--radius-sm);
    padding:4px 8px;
    color:var(--text-main);
    font-size:11px;
    line-height:1.3;
    margin:2px 4px 0;
    word-break:break-all;
    max-width:100%;
  }
  .addrTag.muted,
  .netTag.muted {
    color:var(--text-dim);
  }

  .fieldset {
    margin-top:20px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .fieldLabel {
    font-size:12px;
    color:var(--text-dim);
    display:flex;
    justify-content:space-between;
  }
  .fieldLabel .right {
    color:var(--text-main);
    font-weight:500;
  }

  .inputLike,
  input[type="number"] {
    width:100%;
    border-radius:var(--radius-sm);
    background:rgba(0,0,0,.3);
    border:1px solid var(--accent);
    color:var(--text-main);
    font-size:14px;
    line-height:1.4;
    padding:10px 12px;
    outline:none;
    box-shadow:0 0 12px rgba(0,191,255,.2);
    font-family:inherit;
  }

  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{
    -webkit-appearance:none;
    margin:0;
  }

  /* ボタン */
  .btn {
    width:100%;
    border-radius:var(--radius-sm);
    border:1px solid var(--accent);
    background:rgba(0,191,255,.08);
    color:var(--text-main);
    padding:12px;
    font-size:14px;
    font-weight:600;
    text-align:center;
    cursor:pointer;
    box-shadow:0 0 12px rgba(0,191,255,.3),0 0 40px rgba(0,191,255,.15);
    transition:all .12s linear;
    font-family:inherit;
  }
  .btn[disabled]{
    opacity:.4;
    cursor:not-allowed;
    box-shadow:none;
  }
  .btnPrimary{
    background:radial-gradient(circle at 50% -10%, rgba(0,191,255,.4) 0%, rgba(0,191,255,0) 70%),
               rgba(0,191,255,.08);
  }
  .btnDanger{
    border-color:#f87171;
    box-shadow:0 0 12px rgba(248,113,113,.4),0 0 40px rgba(248,113,113,.2);
    color:#fff;
  }
  .btnWarn{
    border-color:#facc15;
    box-shadow:0 0 12px rgba(250,204,21,.4),0 0 40px rgba(250,204,21,.15);
    color:#fff;
  }

  /* log area */
  .logWrap {
    margin-top:20px;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(148,163,184,.3);
    border-radius:var(--radius-sm);
    font-family:ui-monospace,Menlo,Consolas,monospace;
    font-size:12px;
    line-height:1.5;
    color:var(--text-main);
    min-height:120px;
    max-height:200px;
    overflow-y:auto;
    padding:12px;
    white-space:pre-wrap;
  }
  .logLine      { color:var(--text-main); }
  .log-ok       { color:var(--text-ok); }
  .log-warn     { color:var(--text-warn); }
  .log-err      { color:var(--text-err);  }

  .footNote {
    text-align:center;
    margin-top:16px;
    font-size:12px;
    color:var(--text-dim);
    line-height:1.4;
  }
  .tagMini {
    display:inline-block;
    margin-top:6px;
    font-size:10px;
    line-height:1.3;
    color:var(--text-warn);
    background:rgba(250,204,21,.08);
    border:1px solid rgba(250,204,21,.4);
    border-radius:999px;
    padding:2px 8px;
    box-shadow:0 0 12px rgba(250,204,21,.4);
  }

  @media(max-width:480px){
    .card{max-width:360px;padding:20px 20px 16px;}
    .meteor-icon{width:56px;height:56px;font-size:22px;}
    .title-main{font-size:18px;}
    .subtitle{font-size:13px;}
    .btn{font-size:14px;padding:12px;}
    .fieldLabel{font-size:12px;}
  }
</style>
</head>

<body>
  <div class="card">
    <div class="meteor-icon">☄</div>

    <div class="title-main">MLG Access</div>
    <div class="subtitle">“Worlds Have Value”<br>LG でテストNFTを購入できます</div>

    <!-- 接続状態 -->
    <div class="statusRow">
      <div id="addr" class="addrTag muted">ウォレット未接続</div>
      <div id="net"  class="netTag muted">Network: -</div>
    </div>

    <!-- 入力・表示 -->
    <div class="fieldset">

      <!-- 数量 -->
      <div>
        <div class="fieldLabel">
          <span>購入数 (Qty)</span>
          <span class="right"><span id="priceEach">-</span> / NFT</span>
        </div>
        <input id="qty" type="number" min="1" value="1" />
      </div>

      <!-- コスト / 残高 -->
      <div>
        <div class="fieldLabel">
          <span>必要LG (自動計算)</span>
          <span class="right" id="need">-</span>
        </div>
        <div class="fieldLabel" style="margin-top:6px">
          <span>あなたの残高 (LG)</span>
          <span class="right" id="balance">-</span>
        </div>
      </div>

      <!-- Allowance -->
      <div>
        <div class="fieldLabel">
          <span>許可額 Allowance</span>
          <span class="right" id="allow">-</span>
        </div>
        <div class="tagMini">初回は Approve が必要です</div>
      </div>

    </div>

    <!-- アクションボタン群 -->
    <div class="fieldset" style="margin-top:16px">
      <button id="btnConnect" class="btn btnPrimary">Connect Wallet</button>
      <button id="btnApprove" class="btn btnWarn">① Approve LG Token</button>
      <button id="btnMint" class="btn btnPrimary">② Mint NFT</button>
      <button id="btnRefresh" class="btn">情報更新</button>
    </div>

    <!-- ログ -->
    <div class="fieldset" style="margin-top:16px">
      <div class="fieldLabel"><span>ログ</span><span class="right" style="color:var(--text-dim)">RPCフェイルオーバー & デバッグ</span></div>
      <div id="log" class="logWrap"></div>
    </div>

    <div class="footNote">
      ※ Approve は最初の1回だけでOK。<br>
      その後は Mint NFT だけで繰り返し購入できます。
    </div>
  </div>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <script type="module">
    /********************************************************
     * SETTINGS / CONSTANTS
     ********************************************************/
    const { BrowserProvider, JsonRpcProvider, Contract, formatUnits } = ethers;

    // Polygon Amoy
    const CHAIN_ID = 80002;
    const CHAIN_PARAMS = {
      chainId: '0x13882',
      chainName: 'Polygon Amoy',
      nativeCurrency: { name: 'MATIC', symbol: 'POL', decimals: 18 },
      rpcUrls: [
        'https://polygon-amoy.g.alchemy.com/v2/wf89gpuUltz8_F74z0hoB',
        'https://rpc-amoy.polygon.technology',
        'https://rpc.ankr.com/polygon_amoy',
      ],
      blockExplorerUrls: ['https://amoy.polygonscan.com']
    };

    // アドレス
    const SALE_ADDRESS  = '0x4CD52DC71DaeB382cD736eCd2d9a821192A914dE'; // PlayerSaleERC20_MintLevel1
    const TOKEN_ADDRESS = '0xf5E7662fD4031Eb4Dad19DA8961E01A5d9F90F46'; // LG token
    const DECIMALS      = 18;

    // ABI
    const ERC20_ABI = [
      'function decimals() view returns (uint8)',
      'function allowance(address owner, address spender) view returns (uint256)',
      'function balanceOf(address account) view returns (uint256)',
      'function approve(address spender, uint256 amount) returns (bool)',
      'function paused() view returns (bool)',
      'function isFrozen(address user) view returns (bool)',
    ];
    const SALE_ABI = [
      'function price() view returns (uint256)',
      'function paused() view returns (bool)',
      'function buyQty(uint256 qty)',
    ];

    /********************************************************
     * UI elements
     ********************************************************/
    const $addr     = document.querySelector('#addr');
    const $net      = document.querySelector('#net');
    const $qty      = document.querySelector('#qty');
    const $need     = document.querySelector('#need');
    const $balance  = document.querySelector('#balance');
    const $allow    = document.querySelector('#allow');
    const $priceEach= document.querySelector('#priceEach');
    const $log      = document.querySelector('#log');

    const btnConnect = document.querySelector('#btnConnect');
    const btnApprove = document.querySelector('#btnApprove');
    const btnMint    = document.querySelector('#btnMint');
    const btnRefresh = document.querySelector('#btnRefresh');

    /********************************************************
     * wallet / provider state
     ********************************************************/
    let browserProvider, signer, userAddress;

    /********************************************************
     * logging helpers
     ********************************************************/
    function pushLog(msg, cls="logLine"){
      const t = new Date().toLocaleTimeString();
      $log.innerHTML += `<div class="${cls}">[${t}] ${msg}</div>`;
      $log.scrollTop = $log.scrollHeight;
      console.debug(msg);
    }
    function ok(msg){   pushLog(msg,"log-ok"); }
    function warn(msg){ pushLog(msg,"log-warn"); }
    function err(msg){  pushLog(msg,"log-err"); }

    /********************************************************
     * Multi-RPC read fallback
     ********************************************************/
    const readProviders = CHAIN_PARAMS.rpcUrls.map(u => new JsonRpcProvider(u, CHAIN_ID));

    async function withProviders(fn, label='read', maxRetry=3){
      let lastErr;
      for (let r=0; r<maxRetry; r++){
        for (const [i,p] of readProviders.entries()){
          try{
            if (r>0 || i>0) warn(`retry ${label} via RPC#${i+1}`);
            return await fn(p);
          }catch(e){
            lastErr = e;
            err(`${label} fail RPC#${i+1}: ${e.message||e}`);
          }
        }
        await new Promise(res=>setTimeout(res, 800*(r+1)));
      }
      throw lastErr;
    }

    /********************************************************
     * Ensure wallet / chain
     ********************************************************/
    async function ensureWallet(){
      if(!window.ethereum){
        alert('ウォレット(MetaMask等)を用意してください');
        throw new Error('no wallet');
      }
      const chainIdHex = await window.ethereum.request({ method:'eth_chainId' });
      if(parseInt(chainIdHex,16)!==CHAIN_ID){
        try{
          await window.ethereum.request({
            method:'wallet_switchEthereumChain',
            params:[{ chainId: CHAIN_PARAMS.chainId }]
          });
        }catch(e){
          if(e.code===4902){
            await window.ethereum.request({
              method:'wallet_addEthereumChain',
              params:[CHAIN_PARAMS]
            });
          }else throw e;
        }
      }
      browserProvider = new BrowserProvider(window.ethereum);
      signer = await browserProvider.getSigner();
      userAddress = await signer.getAddress();
      $addr.textContent = userAddress;
      $addr.classList.remove('muted');
      $net.textContent = 'Network: Polygon Amoy';
      $net.classList.remove('muted');
      ok(`Connected: ${userAddress}`);
    }

    /********************************************************
     * contract helpers
     ********************************************************/
    function saleRead(p){ return new Contract(SALE_ADDRESS,  SALE_ABI,  p); }
    function tokenRead(p){return new Contract(TOKEN_ADDRESS, ERC20_ABI, p); }
    function saleWrite(){ return new Contract(SALE_ADDRESS,  SALE_ABI,  signer); }
    function tokenWrite(){return new Contract(TOKEN_ADDRESS, ERC20_ABI, signer); }

    async function fetchPrice(){
      return await withProviders(async(p)=> saleRead(p).price(), 'price()');
    }
    async function fetchSalePaused(){
      return await withProviders(async(p)=> saleRead(p).paused(), 'sale.paused()');
    }
    async function fetchAllowance(owner,spender){
      return await withProviders(async(p)=> tokenRead(p).allowance(owner,spender), 'allowance()');
    }
    async function fetchBalance(owner){
      return await withProviders(async(p)=> tokenRead(p).balanceOf(owner), 'balanceOf()');
    }
    async function fetchTokenPaused(){
      return await withProviders(async(p)=> tokenRead(p).paused(), 'token.paused()');
    }
    async function fetchFrozen(addr){
      return await withProviders(async(p)=> tokenRead(p).isFrozen(addr), 'token.isFrozen()');
    }

    /********************************************************
     * refresh UI
     ********************************************************/
    async function refreshUI(){
      try{
        const qtyVal = Math.max(1, parseInt($qty.value||'1',10));

        const [priceBN, pausedSale, balBN, allowBN, pausedToken, userFrozen, saleFrozen] =
          await Promise.all([
            fetchPrice(),
            fetchSalePaused(),
            userAddress ? fetchBalance(userAddress):0n,
            userAddress ? fetchAllowance(userAddress, SALE_ADDRESS):0n,
            fetchTokenPaused(),
            userAddress ? fetchFrozen(userAddress):false,
            fetchFrozen(SALE_ADDRESS),
          ]);

        const needBN = priceBN * BigInt(qtyVal);

        $priceEach.textContent = `${formatUnits(priceBN,DECIMALS)} LG`;
        $need.textContent      = `${formatUnits(needBN,DECIMALS)} LG`;
        $balance.textContent   = userAddress ? `${formatUnits(balBN,DECIMALS)} LG` : '-';
        $allow.textContent     = userAddress ? `${formatUnits(allowBN,DECIMALS)} LG` : '-';

        pushLog(`price=${formatUnits(priceBN,DECIMALS)} LG / qty=${qtyVal} / need=${formatUnits(needBN,DECIMALS)} LG`);
        if(pausedSale){
          warn('販売コントラクト側: 一時停止(paused=true)');
        }
        if(pausedToken){
          warn('LGトークン側: トークンpause中 (approve不可)');
        }
        if(userFrozen){
          err('あなたのアドレスはLG側でfrozen扱いです (transfer/approve不可)');
        }
        if(saleFrozen){
          warn('販売コントラクトがLG側でfrozen扱いです (approve不可の可能性)');
        }

      }catch(e){
        err(`refreshUI error: ${e.message||e}`);
      }
    }

    /********************************************************
     * Approve (初回 or 残りが足りない時に手動で押す)
     ********************************************************/
    async function doApprove(){
      try{
        await ensureWallet();

        // いまの必要額を計算
        const qtyVal = Math.max(1, parseInt($qty.value||'1',10));
        const priceBN = await fetchPrice();
        const needBN  = priceBN * BigInt(qtyVal);

        // ちょっと多めに許可(100倍とか)
        const targetAllowance = needBN * 100n;

        warn(`approve開始: ${formatUnits(targetAllowance,DECIMALS)} LG を許可します`);
        const tx = await tokenWrite().approve(SALE_ADDRESS, targetAllowance.toString());
        pushLog(`approve tx sent: ${tx.hash}`);
        const rc = await tx.wait(1);
        ok(`approve confirmed in block ${rc.blockNumber}`);

        await refreshUI();
      }catch(e){
        const msg = (e?.info?.error?.message) || e?.shortMessage || e?.message || String(e);
        if(msg.toLowerCase().includes('user rejected')){
          warn('ユーザーが署名を拒否しました');
        }else{
          err(`approve error: ${msg}`);
        }
      }
    }

    /********************************************************
     * Mint (buyQty)
     * ここは buyOnly() と同じイメージ: approveしないで即購入
     ********************************************************/
    async function doMint(){
      try{
        await ensureWallet();
        const qtyVal = Math.max(1, parseInt($qty.value||'1',10));

        pushLog('sending buyQty...');
        const tx = await saleWrite().buyQty(qtyVal);
        pushLog(`mint tx sent: ${tx.hash}`);

        const rc = await tx.wait(1);
        ok(`mint confirmed in block ${rc.blockNumber}`);
        alert('購入完了！ウォレットのNFTを確認してください。');

        await refreshUI();
      }catch(e){
        const raw = (e?.info?.error?.message) || e?.shortMessage || e?.message || String(e);

        // ざっくり分類して人間向けに
        if(/insufficient funds/i.test(raw)){
          err('ガス(POL)またはLG残高が不足しています');
        }else if(/allowance/i.test(raw) || /allowanc/i.test(raw)){
          err('Allowance不足: 先に「① Approve LG Token」を押してください');
        }else if(/paused/i.test(raw)){
          warn('販売が一時停止中またはトークンがpause中です');
        }else if(/frozen/i.test(raw) || /unavailable/i.test(raw)){
          err('このアドレスまたはコントラクトは現在ロックされています');
        }else if(/user rejected/i.test(raw)){
          warn('ウォレットでキャンセルされました');
        }else if(/-32603/.test(raw) || /Internal JSON-RPC error/i.test(raw)){
          err('RPCがトランザクションを拒否しました (-32603)。Allow/Approve状況または一時的なRPC不調の可能性があります');
        }else{
          err(`mint error: ${raw}`);
        }
      }
    }

    /********************************************************
     * wire up events
     ********************************************************/
    btnConnect.onclick = async ()=>{ await ensureWallet(); await refreshUI(); };
    btnRefresh.onclick = refreshUI;
    btnApprove.onclick = doApprove;
    btnMint.onclick    = doMint;
    $qty.oninput       = refreshUI;

    // 初期ロード（価格などの読み取り）
    refreshUI();
  </script>
</body>
</html>
